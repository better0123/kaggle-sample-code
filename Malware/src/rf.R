# rf.R
#
# Runs a random forest for feature selection 
#
# usage:  cat rf.R | R --vanilla --args <features_file>  
# usage:  Rscript rf.R <features_file>  
#
# --------------------------------------------------------------

library('randomForest')

FEATURES_FILE  <- commandArgs( trailingOnly=TRUE )[1] 
LABELS_FILE    <- "/home/chefele/kaggle/Malware/download/trainLabels.csv"

NTREE          <- 500
TREE_NODE_SIZE <- 20
RND_SEED       <- 4242
set.seed(RND_SEED)

# --------------------------------------------------------------

multiclass.logloss <- function(labels.prob, labels.int) {
    label.bin <- 1*(outer( rep(1, nrow(labels.prob)), c(1:9) ) == labels.int) 
    label.bin.prob <- as.matrix(label.bin * labels.prob)
    m <- rowSums(label.bin.prob)
    m.clip <- pmax(pmin(m, 1.0 - 1E-15), 1E-15)
    -mean(log(m.clip))
}

# --------------------------------------------------------------

cat('Reading labels from  :', LABELS_FILE,'\n')
id.labels   <- read.csv(LABELS_FILE)
cat('Reading features from:', FEATURES_FILE,'\n')
id.features <- read.csv(FEATURES_FILE)

cat('Preparing features\n')
features <- merge(id.features, id.labels, by="Id")
labels   <- as.factor(features$Class)
labels.int <- features$Class
features$Class <- NULL
features$Id    <- NULL
features$Rand <- runif(nrow(features))

rf <- randomForest( features, labels, 
                    ntree=NTREE, nodesize=TREE_NODE_SIZE, 
                    importance=TRUE, do.trace=TRUE ) 

cat("\nVARIABLE IMPORTANCE\n")
rf.imp <- as.data.frame(importance(rf))
print(rf.imp)

cat("\nSORTED VARIABLE IMPORTANCE\n")
sort.field <- "MeanDecreaseAccuracy"
rf.imp.sort <- rf.imp[ order(rf.imp[[sort.field]], decreasing=TRUE) , ]
print(rf.imp.sort)

cat("\nPREDICTIONS\n")
preds <- predict(rf, newdata=features, type='prob')
print(head(preds))
cat("\nVOTES\n")
print(head(rf$votes))

mlogloss <- multiclass.logloss(preds, labels.int)
cat('\nMULTICLASS-LOGLOSS: ', mlogloss, '\n')

